{% extends "base.html" %}
{% load static %}
{% block title %}
ë‚´ ë…í›„ê° ë¦¬ìŠ¤íŠ¸
{% endblock %}
{% block content %}
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Gamja+Flower&family=Jua&display=swap" rel="stylesheet">
<style>
    html, body {
        height: 100%; /* ì „ì²´ ë†’ì´ ì°¨ì§€ */
        margin: 0;
        padding: 0;
    }
    .gamja-flower-regular {
        font-family: "Gamja Flower", sans-serif;
        font-weight: 400;
        font-style: normal;
    }
    .review-container {
        background: url("{% static 'images/ë°°ê²½.png' %}") no-repeat center center;
        background-size: cover;
        padding: 20px;
        border-radius: 10px;
        width: 100%;
        height: 100%; /* ì „ì²´ ë†’ì´ ì°¨ì§€ */
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center; /* ìˆ˜ì§ ê°€ìš´ë° ì •ë ¬ */
    }
    .review-container h1 {
        text-align: center;
        margin-bottom: 20px;
        font-weight: bold;
        color: black; /* í…ìŠ¤íŠ¸ ìƒ‰ìƒ */
        font-size: 40px; /* ì ˆëŒ€ í¬ê¸° */
    }
    .review-question {
        position: relative;
        display: flex;
        flex-direction: column;
        margin-bottom: 20px;
    }
    .review-question label {
        font-weight: bold;
        color: black; /* í…ìŠ¤íŠ¸ ìƒ‰ìƒ */
        margin-bottom: 5px;
        font-size: 25px; /* ì ˆëŒ€ í¬ê¸° */
    }
    .review-question textarea {
        width: 100%;
        height: 100px;
        padding: 10px;
        border-radius: 5px;
        border: 1px solid #ddd;
        resize: none;
        font-size: 25px; /* ì ˆëŒ€ í¬ê¸° */
    }
    .submit-button-container {
        display: flex;
        justify-content: center; /* ìˆ˜í‰ ê°€ìš´ë° ì •ë ¬ */
        width: 100%;
        margin-top: 20px;
    }
    .submit-button {
        padding: 10px 20px;
        background-color: #4CAF50;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 1.2em;
    }
    .submit-button:hover {
        background-color: #333333;
    }
    .review-middle {
        display: flex; /* ë¶€ëª¨ ìš”ì†Œë¥¼ flex containerë¡œ ì„¤ì • */
        justify-content: space-between; /* ìì‹ ìš”ì†Œë“¤ ì‚¬ì´ì— ê· ë“±í•œ ê°„ê²© ë°°ë¶„ */
        gap: 10px; /* ìì‹ ìš”ì†Œë“¤ ì‚¬ì´ì— ê°„ê²© ì„¤ì • */
    }
    .review-middle textarea {
        height: 500px;
        padding: 10px;
        border-radius: 5px;
        border: 1px solid #ddd;
        resize: none;
    }
    .n {
        text-shadow:
        -1px -1px 0 #fff,   /* ì™¼ìª½ ìœ„ */
        1px -1px 0 #fff,    /* ì˜¤ë¥¸ìª½ ìœ„ */
        -1px 1px 0 #fff,    /* ì™¼ìª½ ì•„ë˜ */
        1px 1px 0 #fff;     /* ì˜¤ë¥¸ìª½ ì•„ë˜ */
    }
    .canvas {
        width: 100%; /* í™”ë©´ í¬ê¸°ì— ë§ê²Œ ì¡°ì • */
        height: 500px; /* í™”ë©´ í¬ê¸°ì— ë§ê²Œ ì¡°ì • */
        background-color: white;
        border-radius: 15px;
        box-shadow: 0 4px 6px rgba(50, 50, 93, 0.11), 0 1px 3px rgba(0, 0, 0, 0.068);
    }
    .controls {
        margin-top: 20px;
        display: flex;
        flex-direction: column;
        align-items: center;
    }
    .controls_btns {
        display: flex;
        justify-content: center; /* ê°€ìš´ë° ì •ë ¬ */
        gap: 10px; /* ë²„íŠ¼ ì‚¬ì´ì— 10px ê°„ê²© ì¶”ê°€ */
        margin: 20px;
    }
    .controls__btns button {
        all: unset;
        cursor: pointer;
        background-color: white;
        padding: 5px 0px;
        width: 80px;
        text-align: center;
        border-radius: 5px;
        box-shadow: 0 4px 6px rgba(50, 50, 93, 0.11), 0 1px 3px rgba(0, 0, 0, 0.068);
        border: 2px solid rgba(0, 0, 0, 0.2);
        color: rgba(0, 0, 0, 0.8);
        text-transform: uppercase;
        font-weight: 800;
        font-size: 12px;
    }
    .controls__btns button:active {
        transform: scale(0.98);
    }
    .controls .controls__colors {
        display: flex;
        margin-top: 20px;
    }
    .controls__colors .controls__color {
        width: 50px;
        height: 50px;
        border-radius: 25px;
        cursor: pointer;
        box-shadow: 0 4px 6px rgba(50, 50, 93, 0.11), 0 1px 3px rgba(0, 0, 0, 0.068);
    }
    .controls .controls__range {
        margin-bottom: 30px;
    }
</style>

<div class="review-container gamja-flower-regular">
    <h1>{{ review.story_title }} ë…í›„ê° ìˆ˜ì •í•˜ê¸°</h1>
    <form method="post" action="{% url 'review:review_list' review.id %}" class="review-form">
        {% csrf_token %}
        <div class="review-question">
            <label for="title">ğŸ’ğŸ½ ë…í›„ê°ì˜ ì´ë¦„ì„ ìˆ˜ì •í•´ì£¼ì„¸ìš”!</label>
            {{ form.title }}
        </div>
        {% comment %} <div class="review-middle">
            <div class="review-question">
                <label for="main_character">ğŸ’ğŸ½ ëˆ„êµ¬ì˜ ì´ì•¼ê¸°ì¸ê°€ìš”?</label>
                {{ form.main_character }}
            </div>
            <div class="review-question">
                <label for="content">ğŸ’ğŸ½ ë¬´ìŠ¨ ì¼ì´ ì¼ì–´ë‚¬ë‚˜ìš”?</label>
                {{ form.content }}
            </div>
            <div class="review-question">
                <label for="ending">ğŸ’ğŸ½ ì–´ë–»ê²Œ ë˜ì—ˆë‚˜ìš”?</label>
                {{ form.ending }}
            </div>
        </div>
        
        <div class="review-question n">
            <label for="author_thoughts">ğŸ’ğŸ½ ë‚˜ì˜ ìƒê°</label>
            {{ form.author_thoughts }}
        </div> {% endcomment %}

        <canvas id="jsCanvas" class="canvas"></canvas>
        <div class="controls">
            <div class="controls__range">
                <input type="range" id="jsRange"
                min="0.1" max="5.0" value="2.5" step="0.1"/>
            </div>
            <div class="controls__btns">
                <button type="button" id="jsMode">Fill</button>
                <button type="button" id="jsEraser">Eraser</button> <!-- ì§€ìš°ê°œ ë²„íŠ¼ ì¶”ê°€ -->
                <button type="button" id="jsClear">Clear</button> <!-- Clear ë²„íŠ¼ ì¶”ê°€ -->
            </div>
            <div class="controls__colors" id="jsColors">
                <div class="controls__color jsColor" 
                    style="background-color: black;"></div>
                <div class="controls__color jsColor" 
                    style="background-color: white;"></div>
                <div class="controls__color jsColor" 
                    style="background-color: red;"></div>
                <div class="controls__color jsColor" 
                    style="background-color: orange;"></div>
                <div class="controls__color jsColor" 
                    style="background-color: yellow;"></div>
                <div class="controls__color jsColor" 
                    style="background-color: green;"></div>
                <div class="controls__color jsColor" 
                    style="background-color: blue;"></div>
                <div class="controls__color jsColor" 
                    style="background-color: navy;"></div>
                <div class="controls__color jsColor" 
                    style="background-color: purple;"></div>
            </div>
        </div>
        <input type="hidden" name="image_data" id="jsImageInput">
        <div class="submit-button-container">
            <button type="submit" class="submit-button">ì €ì¥</button>
        </div>
    </form>
</div>

<script>
    const canvas = document.getElementById("jsCanvas");
    const ctx = canvas.getContext("2d");
    const colors = document.getElementsByClassName("jsColor");
    const range = document.getElementById("jsRange");
    const mode = document.getElementById("jsMode");
    const eraser = document.getElementById("jsEraser");
    const clearButton = document.getElementById("jsClear"); // Clear ë²„íŠ¼ ê°€ì ¸ì˜¤ê¸°
    const submitBtn = document.querySelector(".submit-button"); // ì €ì¥ ë²„íŠ¼

    const form = document.querySelector(".review-form");
    const imageInput = document.getElementById("jsImageInput");

    const INITIAL_COLOR = "#000000";
    const ERASER_SIZE = 30; // ì§€ìš°ê°œ í¬ê¸°
    const BACKGROUND_COLOR = "white"; // ë°°ê²½ ìƒ‰ìƒ

    // ìº”ë²„ìŠ¤ì˜ ìŠ¤íƒ€ì¼ í¬ê¸° ì„¤ì •
    canvas.style.width = "100%";
    canvas.style.height = "500px";

    // ìº”ë²„ìŠ¤ì˜ ì‹¤ì œ í¬ê¸° ì„¤ì •
    canvas.width = canvas.clientWidth;
    canvas.height = canvas.clientHeight;

    ctx.fillStyle = BACKGROUND_COLOR;
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    ctx.strokeStyle = INITIAL_COLOR;
    ctx.fillStyle = INITIAL_COLOR;
    ctx.lineWidth = 2.5; /* ë¼ì¸ êµµê¸° */

    let painting = false;
    let filling = false;
    let erasing = false; // ì§€ìš°ê°œ ëª¨ë“œ ë³€ìˆ˜

    function stopPainting() {
        painting = false;
    }

    function startPainting() {
        painting = true;
    }

    function onMouseMove(event) {
        const rect = canvas.getBoundingClientRect(); // ìº”ë²„ìŠ¤ì˜ ìœ„ì¹˜ì™€ í¬ê¸°ë¥¼ ê°€ì ¸ì˜´
        const x = event.clientX - rect.left; // ìº”ë²„ìŠ¤ ë‚´ì˜ X ì¢Œí‘œ
        const y = event.clientY - rect.top; // ìº”ë²„ìŠ¤ ë‚´ì˜ Y ì¢Œí‘œ
        if (painting) {
            if (erasing) {
                ctx.fillStyle = BACKGROUND_COLOR; // ì§€ìš°ê°œ ìƒ‰ìƒì€ í•­ìƒ ë°°ê²½ìƒ‰
                ctx.fillRect(x - ERASER_SIZE / 2, y - ERASER_SIZE / 2, ERASER_SIZE, ERASER_SIZE);
            } else {
                ctx.lineTo(x, y);
                ctx.stroke();
            }
        } else {
            ctx.beginPath();
            ctx.moveTo(x, y);
        }
    }

    function handleColorClick(event) {
        const color = event.target.style.backgroundColor;
        ctx.strokeStyle = color;
        ctx.fillStyle = color;
        erasing = false; // ìƒ‰ìƒ ë³€ê²½ ì‹œ ì§€ìš°ê°œ ëª¨ë“œ í•´ì œ
    }

    function handleRangeChange(event) {
        const size = event.target.value;
        ctx.lineWidth = size;
    }

    function handleModeClick() {
        filling = !filling;
        mode.innerText = filling ? "Paint" : "Fill";
        erasing = false; // ëª¨ë“œ ë³€ê²½ ì‹œ ì§€ìš°ê°œ ëª¨ë“œ í•´ì œ
    }

    function handleEraserClick() {
        erasing = !erasing;
        eraser.innerText = erasing ? "Draw" : "Eraser"; // ì§€ìš°ê°œ ëª¨ë“œ í…ìŠ¤íŠ¸ ë³€ê²½
        filling = false; // ì§€ìš°ê°œ ëª¨ë“œ í™œì„±í™” ì‹œ ì±„ìš°ê¸° ëª¨ë“œ í•´ì œ
        mode.innerText = "Fill";
    }

    function handleCanvasClick() {
        if (filling) {
            ctx.fillRect(0, 0, canvas.width, canvas.height);
        }
    }

    function handleClearClick() {
        ctx.fillStyle = BACKGROUND_COLOR;
        ctx.fillRect(0, 0, canvas.width, canvas.height);
    }

    function handleSaveClick() {
        const image = canvas.toDataURL("image/png");
        imageInput.value = image;
        form.submit();
    }

    if (canvas) {
        canvas.addEventListener("mousemove", onMouseMove);
        canvas.addEventListener("mousedown", startPainting);
        canvas.addEventListener("mouseup", stopPainting);
        canvas.addEventListener("mouseleave", stopPainting);
        canvas.addEventListener("click", handleCanvasClick);
    }

    Array.from(colors).forEach(color => 
        color.addEventListener("click", handleColorClick));

    if (range) {
        range.addEventListener("input", handleRangeChange);
    }

    if (eraser) {
        eraser.addEventListener("click", handleEraserClick);
    }

    if (clearButton) {
        clearButton.addEventListener("click", handleClearClick);
    }

    if (submitBtn) {
        submitBtn.addEventListener("click", handleSaveClick); // ì €ì¥ ë²„íŠ¼
    }

    // Load existing painting if available
    const existingPainting = "{{ review.painting.url }}";
    if (existingPainting) {
        const img = new Image();
        img.src = existingPainting;
        img.onload = function() {
            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
        }
    }
</script>
{% endblock %}
